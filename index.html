<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Plataformas V3 - Combate y Enemigos</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background-color: #111; overflow: hidden; touch-action: none; }
        canvas { display: block; }
    </style>
</head>
<body>

<script>
    const config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.RESIZE, // Adaptable a cualquier pantalla
            width: '100%',
            height: '100%'
        },
        input: { activePointers: 4 }, // Aumentamos pointers para disparar + correr + saltar
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 1200 },
                debug: false
            }
        },
        scene: { preload: preload, create: create, update: update }
    };

    // VARIABLES GLOBALES
    let player, platforms, cursors, door;
    let ghosts, rocks, spikes; // Grupos de objetos
    let uiContainer;
    
    // ESTADO DEL JUEGO
    let lives = 3;
    let ammo = 10;
    let score = 0;
    let lastFired = 0; // Para controlar la velocidad de disparo
    let isGameOver = false;

    // UI TEXTOS
    let txtLives, txtAmmo;
    
    // CONTROLES
    let moveLeft = false, moveRight = false, jump = false, shoot = false;
    let facingRight = true; // Para saber a dÃ³nde lanzar la piedra

    const game = new Phaser.Game(config);

    function preload() {
        this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
        this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
        this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
    }

    function create() {
        // --- 1. GENERACIÃ“N DE TEXTURAS (DIBUJO MANUAL) ---
        // Creamos grÃ¡ficos para no depender de imÃ¡genes externas para enemigos/balas
        
        // FANTASMA
        let g = this.make.graphics({x:0, y:0, add: false});
        g.fillStyle(0xffffff, 0.8);
        g.fillCircle(16, 16, 16); // Cabeza
        g.fillRect(0, 16, 32, 16); // Cuerpo
        g.generateTexture('ghostTex', 32, 32);

        // ROCA
        g.clear();
        g.fillStyle(0x888888, 1);
        g.fillCircle(8, 8, 8);
        g.generateTexture('rockTex', 16, 16);

        // PINCHOS (ObstÃ¡culo)
        g.clear();
        g.fillStyle(0xff0000, 1);
        g.beginPath();
        g.moveTo(0, 32); g.lineTo(16, 0); g.lineTo(32, 32); // TriÃ¡ngulo
        g.closePath();
        g.fillPath();
        g.generateTexture('spikeTex', 32, 32);


        // --- 2. CONFIGURACIÃ“N MUNDO ---
        const width = this.scale.width;
        const height = this.scale.height;
        
        // Mundo mÃ¡s largo (Nivel mÃ¡s completo)
        const worldWidth = width > height ? width * 2.5 : width * 1.5; 
        this.physics.world.setBounds(0, 0, worldWidth, height);

        // Fondo Parallax
        this.add.tileSprite(0, 0, worldWidth, height, 'sky').setOrigin(0, 0).setScrollFactor(0.5);

        // --- 3. PLATAFORMAS Y OBSTÃCULOS ---
        platforms = this.physics.add.staticGroup();
        spikes = this.physics.add.staticGroup();

        // Suelo Base
        let groundY = height - 60;
        platforms.create(worldWidth/2, groundY, 'ground').setScale(15, 2).refreshBody();

        // Nivel Construido Manualmente
        createLevel(worldWidth, groundY);

        // --- 4. JUGADOR ---
        player = this.physics.add.sprite(100, groundY - 100, 'dude');
        player.setBounce(0.1);
        player.setCollideWorldBounds(true);

        this.anims.create({ key: 'left', frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
        this.anims.create({ key: 'turn', frames: [ { key: 'dude', frame: 4 } ], frameRate: 20 });
        this.anims.create({ key: 'right', frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }), frameRate: 10, repeat: -1 });

        // --- 5. GRUPOS DE ENTIDADES ---
        
        // GRUPO DE ROCAS (Balas)
        rocks = this.physics.add.group({
            defaultKey: 'rockTex',
            maxSize: 10
        });

        // GRUPO DE FANTASMAS
        ghosts = this.physics.add.group();
        // Crear enemigos en posiciones fijas
        spawnGhost(500, groundY - 200);
        spawnGhost(worldWidth * 0.6, groundY - 350);
        spawnGhost(worldWidth * 0.8, groundY - 150);

        // --- 6. COLISIONES ---
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(ghosts, platforms);
        this.physics.add.collider(rocks, platforms, (rock) => { rock.destroy(); }); // Roca choca pared -> desaparece
        this.physics.add.collider(player, spikes, hitSpike, null, this);

        // Interacciones clave
        this.physics.add.overlap(player, ghosts, hitGhost, null, this);
        this.physics.add.overlap(rocks, ghosts, killGhost, null, this);
        this.physics.add.overlap(player, door, winGame, null, this);

        // --- 7. CÃMARA Y CONTROLES ---
        this.cameras.main.setBounds(0, 0, worldWidth, height);
        this.cameras.main.startFollow(player, true, 0.08, 0.08);
        cursors = this.input.keyboard.createCursorKeys();

        // --- 8. UI ---
        createInterface(this, width, height);
    }

    function createLevel(worldWidth, groundY) {
        // Generador de plataformas
        const p = platforms;
        const s = spikes;

        // Plataforma 1 con pinchos abajo
        p.create(400, groundY - 120, 'ground');
        s.create(400, groundY - 35, 'spikeTex'); // Pincho en el suelo

        // Escalera subiendo
        p.create(700, groundY - 220, 'ground');
        p.create(950, groundY - 320, 'ground');

        // Zona de salto largo
        p.create(1300, groundY - 250, 'ground');
        s.create(1300, groundY - 282, 'spikeTex'); // Pincho sorpresa ARRIBA de la plataforma

        // Plataforma alta final
        let finalPlatX = worldWidth - 200;
        let finalPlatY = groundY - 400;
        p.create(finalPlatX, finalPlatY, 'ground').setScale(1.5, 1).refreshBody();

        // PUERTA
        door = this.add.container(finalPlatX, finalPlatY - 60); // Sobre la plataforma final
        let doorFrame = this.add.rectangle(0, 0, 50, 70, 0x555555).setStrokeStyle(2, 0xaaaaaa);
        let doorInner = this.add.rectangle(0, 0, 40, 60, 0x331111);
        let doorKnob = this.add.circle(15, 5, 3, 0xffd700);
        let exitText = this.add.text(-18, -45, 'EXIT', { fontSize: '12px', color: '#0f0', fontStyle: 'bold' });
        door.add([doorFrame, doorInner, doorKnob, exitText]);
        this.physics.world.enable(door);
        door.body.setAllowGravity(false);
        door.body.setImmovable(true);
    }

    function spawnGhost(x, y) {
        let ghost = ghosts.create(x, y, 'ghostTex');
        ghost.setBounce(1);
        ghost.setCollideWorldBounds(true);
        ghost.setVelocityX(-100); // Empieza moviÃ©ndose
        ghost.body.allowGravity = false; // Vuela
        // AnimaciÃ³n simple de flotar
        game.scene.scenes[0].tweens.add({
            targets: ghost,
            y: y - 30,
            duration: 1500,
            yoyo: true,
            repeat: -1
        });
    }

    function update(time, delta) {
        if (isGameOver) return;

        // --- MOVIMIENTO ---
        const isLeft = moveLeft || cursors.left.isDown;
        const isRight = moveRight || cursors.right.isDown;
        const isJump = jump || cursors.up.isDown || cursors.space.isDown;
        const isShoot = shoot; // BotÃ³n presionado

        // Disparo con teclado (Tecla Z)
        const keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);

        if (isLeft) {
            player.setVelocityX(-250);
            player.anims.play('left', true);
            facingRight = false;
        } else if (isRight) {
            player.setVelocityX(250);
            player.anims.play('right', true);
            facingRight = true;
        } else {
            player.setVelocityX(0);
            player.anims.play('turn');
        }

        if (isJump && (player.body.touching.down || player.body.blocked.down)) {
            player.setVelocityY(-650); // Salto limitado y controlado
            jump = false; 
        }

        // --- LÃ“GICA DE DISPARO ---
        if ((isShoot || keyZ.isDown) && time > lastFired) {
            fireRock(time);
        }

        // --- UI UPDATES ---
        txtLives.setText('VIDAS: ' + lives);
        txtAmmo.setText('ROCAS: ' + ammo);
    }

    function fireRock(time) {
        if (ammo <= 0) return;

        let rock = rocks.get(); // Obtener del grupo
        if (rock) {
            rock.setActive(true).setVisible(true);
            rock.setPosition(player.x, player.y);
            rock.body.allowGravity = true;
            
            // Velocidad y direcciÃ³n
            let velocityX = facingRight ? 500 : -500;
            rock.setVelocity(velocityX, -200); // Un pequeÃ±o arco hacia arriba

            ammo--;
            lastFired = time + 500; // Cooldown de 500ms
        }
    }

    function hitGhost(player, ghost) {
        playerHurt();
    }

    function hitSpike(player, spike) {
        playerHurt();
    }

    function playerHurt() {
        // PequeÃ±o rebote al ser daÃ±ado
        player.setVelocityY(-300);
        player.setTint(0xff0000);
        
        // Quitar vida
        lives--;
        
        // Reset posiciÃ³n (checkpoint simple)
        player.x = 100;
        player.y = 300;
        player.clearTint();

        if (lives <= 0) {
            physicsPause();
            txtLives.setText('VIDAS: 0');
            alert("ðŸ‘» GAME OVER ðŸ‘»\nTe quedaste sin vidas.");
            location.reload();
        }
    }

    function killGhost(rock, ghost) {
        rock.destroy();
        ghost.destroy(); // Â¡AdiÃ³s fantasma!
        score += 100;
    }

    function winGame() {
        physicsPause();
        alert("ðŸŽ‰ Â¡NIVEL COMPLETADO! ðŸŽ‰\nTe sobraron " + ammo + " rocas.");
        location.reload();
    }

    function physicsPause() {
        game.scene.scenes[0].physics.pause();
        isGameOver = true;
    }

    function createInterface(scene, screenWidth, screenHeight) {
        uiContainer = scene.add.container(0, 0).setScrollFactor(0).setDepth(100);

        // --- BARRA SUPERIOR (Vidas y Rocas) ---
        let topBar = scene.add.graphics();
        topBar.fillStyle(0x000000, 0.5);
        topBar.fillRect(0, 0, screenWidth, 40);
        uiContainer.add(topBar);

        txtLives = scene.add.text(20, 10, 'VIDAS: 3', { fontSize: '20px', fill: '#ff0000', fontStyle: 'bold' });
        txtAmmo = scene.add.text(screenWidth - 150, 10, 'ROCAS: 10', { fontSize: '20px', fill: '#fff', fontStyle: 'bold' });
        uiContainer.add([txtLives, txtAmmo]);

        // --- BARRA INFERIOR (Controles) ---
        const barHeight = 120;
        const barY = screenHeight - barHeight;
        
        let graphics = scene.add.graphics();
        graphics.fillStyle(0x0a0a0a, 0.9);
        graphics.fillRect(0, barY, screenWidth, barHeight);
        graphics.lineStyle(4, 0x00ff00);
        graphics.lineBetween(0, barY, screenWidth, barY);
        uiContainer.add(graphics);

        const btnY = barY + 60;
        
        // BOTONES MOVIMIENTO
        createBtn(scene, 80, btnY, '<', () => moveLeft = true, () => moveLeft = false);
        createBtn(scene, 200, btnY, '>', () => moveRight = true, () => moveRight = false);

        // BOTÃ“N SALTO (Derecha)
        createBtn(scene, screenWidth - 80, btnY, 'JUMP', () => jump = true, () => jump = false, 0x990000);

        // BOTÃ“N DISPARO (Al lado del salto)
        // Icono de roca (cÃ­rculo gris)
        createBtn(scene, screenWidth - 200, btnY, 'O', () => shoot = true, () => shoot = false, 0x555555);
        // Texto extra "Shoot"
        let shootLabel = scene.add.text(screenWidth - 225, btnY - 40, 'SHOOT', {fontSize:'12px', color:'#aaa'});
        uiContainer.add(shootLabel);
    }

    function createBtn(scene, x, y, text, onPress, onRelease, color = 0x333333) {
        let btn = scene.add.container(x, y);
        let circle = scene.add.circle(0, 0, 40, color).setStrokeStyle(2, 0xffffff);
        let label = scene.add.text(-12, -15, text, { fontSize: '24px', color: '#fff', fontStyle: 'bold' });
        
        // Ajuste de texto centrado si es largo
        if (text.length > 2) label.x = -30;

        let hit = scene.add.circle(0, 0, 50, 0x000000, 0).setInteractive();
        hit.on('pointerdown', () => { onPress(); btn.y += 4; });
        hit.on('pointerup', () => { onRelease(); btn.y -= 4; });
        hit.on('pointerout', () => { onRelease(); btn.y -= 4; });

        btn.add([circle, label, hit]);
        uiContainer.add(btn);
    }
</script>

</body>
</html>
