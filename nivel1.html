<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cubo Saltarín - Estilo Fireboy</title>
    <style>
        * { margin: 0; padding: 0; }
        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Soporte retina
        let dpr = window.devicePixelRatio || 1;

        // Variables globales
        let WIDTH, HEIGHT, WORLD_WIDTH, WORLD_HEIGHT, GROUND, PLAYER_SIZE;
        let GRAVITY, JUMP_FORCE, ACCEL, FRICTION, MAX_SPEED;
        let camX = 0, camTarget = 0;
        let gameWon = false;
        let gemsCollected = 0;
        let totalGems = 3;

        // Estado jugador
        const player = {
            x: 0, y: 0, width: 0, height: 0,
            vx: 0, vy: 0, onGround: false
        };

        // Arrays
        let platforms = [];
        let hazards = [];
        let gems = [];
        let particles = [];

        // Controles
        const keys = {};
        const leftTouches = new Set();
        const rightTouches = new Set();
        const jumpTouches = new Set();

        // Inicializar escala y mundo
        function resize() {
            const rect = canvas.getBoundingClientRect();
            WIDTH = rect.width;
            HEIGHT = rect.height;
            canvas.width = WIDTH * dpr;
            canvas.height = HEIGHT * dpr;
            ctx.scale(dpr, dpr);

            WORLD_WIDTH = Math.max(1800, WIDTH * 2.2);
            WORLD_HEIGHT = HEIGHT;
            GROUND = WORLD_HEIGHT * 0.86;
            PLAYER_SIZE = Math.min(WIDTH * 0.045, HEIGHT * 0.075);
            GRAVITY = PLAYER_SIZE * 0.028;
            JUMP_FORCE = -PLAYER_SIZE * 0.55;
            ACCEL = PLAYER_SIZE * 0.018;
            FRICTION = 0.86;
            MAX_SPEED = PLAYER_SIZE * 0.22;

            // Resetear posiciones escaladas
            resetLevel();
            resetPlayer();
        }

        function resetLevel() {
            // Plataformas (estilo madera)
            platforms = [
                { x: WORLD_WIDTH * 0.28, y: GROUND - PLAYER_SIZE * 1.7, width: PLAYER_SIZE * 1.4, height: PLAYER_SIZE * 0.6 },
                { x: WORLD_WIDTH * 0.48, y: GROUND - PLAYER_SIZE * 2.4, width: PLAYER_SIZE * 1.4, height: PLAYER_SIZE * 0.6 },
                { x: WORLD_WIDTH * 0.72, y: GROUND - PLAYER_SIZE * 1.4, width: PLAYER_SIZE * 1.6, height: PLAYER_SIZE * 0.6 }
            ];

            // Peligros (agua azul)
            hazards = [
                { x: WORLD_WIDTH * 0.22, y: GROUND - PLAYER_SIZE * 0.9, width: PLAYER_SIZE * 2.2, height: PLAYER_SIZE * 0.9 },
                { x: WORLD_WIDTH * 0.65, y: GROUND - PLAYER_SIZE * 0.9, width: PLAYER_SIZE * 1.8, height: PLAYER_SIZE * 0.9 }
            ];

            // Gemas rojas brillantes
            gems = [
                { x: WORLD_WIDTH * 0.32, y: GROUND - PLAYER_SIZE * 4.2, width: PLAYER_SIZE * 0.7, height: PLAYER_SIZE * 0.7, collected: false },
                { x: WORLD_WIDTH * 0.51, y: GROUND - PLAYER_SIZE * 5, width: PLAYER_SIZE * 0.7, height: PLAYER_SIZE * 0.7, collected: false },
                { x: WORLD_WIDTH * 0.76, y: GROUND - PLAYER_SIZE * 3.8, width: PLAYER_SIZE * 0.7, height: PLAYER_SIZE * 0.7, collected: false }
            ];

            // Puerta
            door = { x: WORLD_WIDTH - PLAYER_SIZE * 2.5, y: GROUND - PLAYER_SIZE * 3, width: PLAYER_SIZE * 1.6, height: PLAYER_SIZE * 3, open: false };
        }

        function resetPlayer() {
            player.x = PLAYER_SIZE * 1.5;
            player.y = GROUND - PLAYER_SIZE;
            player.vx = 0;
            player.vy = 0;
            player.onGround = true;
            camX = 0;
            gemsCollected = 0;
            gameWon = false;
            particles = [];
        }

        // Colisión
        function rectCollide(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // Update
        function update() {
            if (gameWon) return;

            // Input
            const left = leftTouches.size > 0 || keys[37] || keys[65];
            const right = rightTouches.size > 0 || keys[39] || keys[68];
            const jump = jumpTouches.size > 0 || keys[32] || keys[38] || keys[87];

            if (left) player.vx = Math.max(player.vx - ACCEL, -MAX_SPEED);
            if (right) player.vx = Math.min(player.vx + ACCEL, MAX_SPEED);
            if (jump && player.onGround) {
                player.vy = JUMP_FORCE;
                player.onGround = false;
            }

            player.vx *= FRICTION;

            // Horizontal
            player.x += player.vx;
            player.x = Math.max(0, Math.min(WORLD_WIDTH - player.width, player.x));

            // Colisiones laterales plataformas/hazards
            for (let plat of platforms) {
                if (rectCollide(player, plat)) {
                    if (player.vx > 0) player.x = plat.x - player.width;
                    if (player.vx < 0) player.x = plat.x + plat.width;
                    player.vx = 0;
                }
            }
            for (let haz of hazards) {
                if (rectCollide(player, haz)) {
                    resetPlayer();
                    return;
                }
            }

            // Vertical
            player.vy += GRAVITY;
            player.y += player.vy;
            player.onGround = false;

            // Suelo
            if (player.y >= GROUND - player.height) {
                player.y = GROUND - player.height;
                player.vy = 0;
                player.onGround = true;
            } else {
                // Plataformas
                for (let plat of platforms) {
                    if (rectCollide(player, plat)) {
                        if (player.vy > 0) {
                            player.y = plat.y - player.height;
                            player.vy = 0;
                            player.onGround = true;
                            break;
                        } else {
                            player.vy = 0;
                        }
                    }
                }
            }

            // Gemas
            for (let gem of gems) {
                if (!gem.collected && rectCollide(player, gem)) {
                    gem.collected = true;
                    gemsCollected++;
                }
            }

            // Puerta
            if (rectCollide(player, door) && gemsCollected === totalGems) {
                gameWon = true;
            }

            // Cámara suave
            camTarget = player.x + player.width / 2 - WIDTH / 2;
            camTarget = Math.max(0, Math.min(camTarget, WORLD_WIDTH - WIDTH));
            camX += (camTarget - camX) * 0.12;

            // Partículas fuego
            emitParticles();
            updateParticles();
        }

        function emitParticles() {
            if (Math.random() < 0.4 || player.onGround) {
                for (let i = 0; i < 2 + Math.random() * 3; i++) {
                    particles.push({
                        x: player.x + player.width / 2 + (Math.random() - 0.5) * player.width * 0.4,
                        y: player.y + player.height,
                        vx: (Math.random() - 0.5) * 3,
                        vy: Math.random() * -1.5 - 1,
                        life: 25 + Math.random() * 25,
                        maxLife: 50
                    });
                }
            }
        }

        function updateParticles() {
            particles = particles.filter(p => {
                p.vy += 0.25;
                p.x += p.vx * 0.7;
                p.y += p.vy * 0.7;
                p.life--;
                p.vx *= 0.98;
                p.vy *= 0.98;
                return p.life > 0;
            });
        }

        // Dibujar
        function draw() {
            ctx.save();
            ctx.translate(-camX, 0);

            // Fondo cueva Fireboy-style
            const bgGrad = ctx.createRadialGradient(
                WIDTH / 2 + camX, HEIGHT / 2, 0,
                WIDTH / 2 + camX, HEIGHT / 2, Math.hypot(WIDTH, WORLD_HEIGHT) / 1.5
            );
            bgGrad.addColorStop(0, '#3a1a0f');
            bgGrad.addColorStop(0.4, '#2c0f05');
            bgGrad.addColorStop(0.7, '#1a0703');
            bgGrad.addColorStop(1, '#000');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);

            // Suelo madera
            ctx.fillStyle = '#5D4037';
            ctx.fillRect(0, GROUND, WORLD_WIDTH, WORLD_HEIGHT - GROUND);
            ctx.strokeStyle = '#8D6E63';
            ctx.lineWidth = 2;
            for (let i = 0; i < WORLD_WIDTH; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND);
                ctx.lineTo(i, WORLD_HEIGHT);
                ctx.stroke();
            }

            // Plataformas madera
            ctx.fillStyle = '#8B4513';
            for (let plat of platforms) {
                ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
                ctx.strokeStyle = '#A0522D';
                ctx.lineWidth = 1.5;
                ctx.strokeRect(plat.x, plat.y, plat.width, plat.height);
                // Líneas madera
                ctx.strokeStyle = '#654321';
                for (let ly = plat.y + 6; ly < plat.y + plat.height; ly += 12) {
                    ctx.beginPath();
                    ctx.moveTo(plat.x, ly);
                    ctx.lineTo(plat.x + plat.width, ly);
                    ctx.stroke();
                }
            }

            // Hazards agua
            for (let haz of hazards) {
                const waterGrad = ctx.createLinearGradient(haz.x, haz.y, haz.x, haz.y + haz.height);
                waterGrad.addColorStop(0, '#4169E1');
                waterGrad.addColorStop(1, '#00008B');
                ctx.fillStyle = waterGrad;
                ctx.beginPath();
                ctx.roundRect(haz.x + 5, haz.y, haz.width - 10, haz.height, 20);
                ctx.fill();
                // Olas
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(haz.x + 10, haz.y + 8);
                ctx.quadraticCurveTo(haz.x + haz.width/2, haz.y + 4, haz.x + haz.width - 10, haz.y + 8);
                ctx.stroke();
            }

            // Gemas
            gems.forEach((gem, i) => {
                if (!gem.collected) {
                    const shine = 1 + 0.15 * Math.sin(Date.now() * 0.008 + i);
                    drawDiamond(gem.x + gem.width/2, gem.y + gem.height/2, gem.width/2 * shine, PLAYER_SIZE);
                }
            });

            // Puerta dorada
            ctx.fillStyle = '#FFD700';
            ctx.shadowColor = '#FF8C00';
            ctx.shadowBlur = PLAYER_SIZE * 0.3;
            ctx.fillRect(door.x, door.y, door.width, door.height);
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#FF4500';
            ctx.fillRect(door.x + door.width * 0.2, door.y + door.height * 0.1, door.width * 0.6, door.height * 0.8);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeRect(door.x, door.y, door.width, door.height);

            // Jugador cubo fuego
            ctx.save();
            ctx.shadowColor = 'rgba(255,100,0,0.6)';
            ctx.shadowBlur = PLAYER_SIZE * 0.4;
            ctx.shadowOffsetY = PLAYER_SIZE * 0.1;
            const fireGrad = ctx.createLinearGradient(player.x, player.y, player.x + player.width, player.y + player.height);
            fireGrad.addColorStop(0, '#FF6B35');
            fireGrad.addColorStop(0.5, '#FF4500');
            fireGrad.addColorStop(1, '#8B0000');
            ctx.fillStyle = fireGrad;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.shadowBlur = 0;
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 2;
            ctx.strokeRect(player.x, player.y, player.width, player.height);
            ctx.restore();

            // Partículas
            particles.forEach(p => {
                const alpha = p.life / p.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha * alpha;
                const col = `hsl(15, 100%, ${40 + p.life * 0.4}%)`;
                ctx.fillStyle = col;
                ctx.beginPath();
                ctx.arc(p.x, p.y, PLAYER_SIZE * 0.015 * (p.life / p.maxLife), 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });

            ctx.restore();

            // UI overlay
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(0, 0, WIDTH, PLAYER_SIZE * 1.5);

            ctx.fillStyle = '#FFD700';
            ctx.font = `bold ${PLAYER_SIZE}px Arial`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(`Gemas: \( {gemsCollected}/ \){totalGems}`, PLAYER_SIZE * 0.5, PLAYER_SIZE * 0.75);

            // Botón Restart arriba derecha
            const restartSize = PLAYER_SIZE * 1.2;
            ctx.fillStyle = '#FF4444';
            ctx.fillRect(WIDTH - restartSize * 1.1, 10, restartSize, PLAYER_SIZE);
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 2;
            ctx.strokeRect(WIDTH - restartSize * 1.1, 10, restartSize, PLAYER_SIZE);
            ctx.fillStyle = 'white';
            ctx.font = `bold ${PLAYER_SIZE * 0.6}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText('R', WIDTH - restartSize * 0.55, PLAYER_SIZE * 0.5);

            // Botones táctiles (fondo semi-trans)
            const btnSize = HEIGHT * 0.14;
            const btnMargin = WIDTH * 0.03;
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(0, HEIGHT - btnSize * 1.1, WIDTH, btnSize * 1.1);

            // ←
            ctx.fillStyle = leftTouches.size ? '#FF5555' : 'rgba(255,80,80,0.8)';
            ctx.fillRect(btnMargin, HEIGHT - btnSize - btnMargin, btnSize, btnSize);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeRect(btnMargin, HEIGHT - btnSize - btnMargin, btnSize, btnSize);
            ctx.fillStyle = 'white';
            ctx.font = `bold ${btnSize * 0.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('←', btnMargin + btnSize / 2, HEIGHT - btnSize - btnMargin + btnSize / 2);

            // →
            const rightBtnX = btnMargin + btnSize + btnMargin * 2;
            ctx.fillStyle = rightTouches.size ? '#55FF55' : 'rgba(80,255,80,0.8)';
            ctx.fillRect(rightBtnX, HEIGHT - btnSize - btnMargin, btnSize, btnSize);
            ctx.strokeRect(rightBtnX, HEIGHT - btnSize - btnMargin, btnSize, btnSize);
            ctx.fillText('→', rightBtnX + btnSize / 2, HEIGHT - btnSize - btnMargin + btnSize / 2);

            // ↑
            const jumpBtnX = WIDTH - btnSize - btnMargin;
            ctx.fillStyle = jumpTouches.size ? '#5555FF' : 'rgba(80,80,255,0.8)';
            ctx.beginPath();
            ctx.arc(jumpBtnX + btnSize / 2, HEIGHT - btnSize - btnMargin + btnSize / 2, btnSize / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.fillText('↑', jumpBtnX + btnSize / 2, HEIGHT - btnSize - btnMargin + btnSize / 2);

            ctx.textAlign = 'left';

            // Victoria
            if (gameWon) {
                ctx.fillStyle = 'rgba(0,0,0,0.9)';
                ctx.fillRect(0, 0, WIDTH, HEIGHT);
                ctx.fillStyle = '#FFD700';
                ctx.shadowColor = '#FF4500';
                ctx.shadowBlur = 30;
                ctx.font = `bold ${Math.min(WIDTH, HEIGHT) * 0.15}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('¡Nivel Completado!', WIDTH / 2, HEIGHT / 2);
                ctx.shadowBlur = 0;
                ctx.font = `bold ${Math.min(WIDTH, HEIGHT) * 0.08}px Arial`;
                ctx.fillStyle = 'white';
                ctx.fillText('Toca R para reiniciar', WIDTH / 2, HEIGHT / 2 + Math.min(WIDTH, HEIGHT) * 0.08);
                ctx.textAlign = 'left';
            }
        }

        function drawDiamond(cx, cy, size) {
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(Date.now() * 0.002);
            ctx.beginPath();
            ctx.moveTo(0, -size);
            ctx.lineTo(size * 0.7, 0);
            ctx.lineTo(0, size);
            ctx.lineTo(-size * 0.7, 0);
            ctx.closePath();
            const gemGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 1.5);
            gemGrad.addColorStop(0, '#FFFFAA');
            gemGrad.addColorStop(0.3, '#FF8C00');
            gemGrad.addColorStop(0.7, '#FF4500');
            gemGrad.addColorStop(1, '#8B0000');
            ctx.fillStyle = gemGrad;
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.8)';
            ctx.lineWidth = 1.5;
            ctx.stroke();
            ctx.restore();
        }

        // Eventos
        window.addEventListener('resize', resize);
        document.addEventListener('keydown', e => {
            keys[e.keyCode] = true;
            if (e.keyCode === 82) resetPlayer(); // R
            e.preventDefault();
        });
        document.addEventListener('keyup', e => { keys[e.keyCode] = false; e.preventDefault(); });

        // Touch
        function handleTouch(e) {
            e.preventDefault();
            const touches = e.changedTouches;
            const btnSize = HEIGHT * 0.14;
            const btnMargin = WIDTH * 0.03;
            const leftRect = {x: btnMargin, y: HEIGHT - btnSize - btnMargin, w: btnSize, h: btnSize};
            const rightRect = {x: btnMargin + btnSize + btnMargin * 2, y: leftRect.y, w: btnSize, h: btnSize};
            const jumpRect = {x: WIDTH - btnSize - btnMargin, y: leftRect.y, w: btnSize, h: btnSize};
            const restartRect = {x: WIDTH - PLAYER_SIZE * 1.32, y: 10, w: PLAYER_SIZE, h: PLAYER_SIZE};

            for (let touch of touches) {
                const x = touch.clientX;
                const y = touch.clientY;
                const id = touch.identifier;

                if (e.type.startsWith('touchend') || e.type === 'touchcancel') {
                    leftTouches.delete(id);
                    rightTouches.delete(id);
                    jumpTouches.delete(id);
                    continue;
                }

                leftTouches.delete(id);
                rightTouches.delete(id);
                jumpTouches.delete(id);

                if (x > leftRect.x && x < leftRect.x + leftRect.w && y > leftRect.y && y < leftRect.y + leftRect.h) {
                    leftTouches.add(id);
                } else if (x > rightRect.x && x < rightRect.x + rightRect.w && y > rightRect.y && y < rightRect.y + rightRect.h) {
                    rightTouches.add(id);
                } else if (x > jumpRect.x && x < jumpRect.x + jumpRect.w && y > jumpRect.y && y < jumpRect.y + jumpRect.h) {
                    jumpTouches.add(id);
                } else if (x > restartRect
