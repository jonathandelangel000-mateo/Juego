<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nivel 1 - El Bosque de Ne칩n</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; touch-action: none; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>

<script>
    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: '#000',
        scale: {
            mode: Phaser.Scale.FIT, // Ajuste perfecto en cualquier pantalla
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        input: { activePointers: 3 }, // Multitouch
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 1200 },
                debug: false
            }
        },
        scene: { preload: preload, create: create, update: update }
    };

    // --- VARIABLES ---
    let player, platforms, door, keyItem;
    let cursors, keyZ; 
    let ghosts, rocks, spikes;
    let uiContainer;
    
    // --- ESTADO DEL JUEGO ---
    let lives = 3;
    let ammo = 10;
    let hasKey = false;
    let lastFired = 0;
    let isGameOver = false;

    // --- CONTROLES ---
    let moveLeft = false, moveRight = false, jump = false, shoot = false;
    let facingRight = true; 

    // Textos UI
    let txtLives, txtAmmo, txtInfo;

    const game = new Phaser.Game(config);

    function preload() {
        // NO cargamos im치genes externas para evitar errores. Todo se genera abajo.
    }

    function create() {
        // ---------------------------------------------------------
        // 1. GENERADOR DE GR츼FICOS (Texturas al vuelo)
        // ---------------------------------------------------------
        let g = this.make.graphics({x:0, y:0, add: false});

        // Cielo (Degradado Azul Oscuro)
        g.fillGradientStyle(0x0f0c29, 0x0f0c29, 0x302b63, 0x24243e, 1);
        g.fillRect(0, 0, 32, 32);
        g.generateTexture('skyTex', 32, 32);

        // Suelo (Verde Ne칩n)
        g.clear();
        g.fillStyle(0x00ff00, 1); g.fillRect(0, 0, 32, 32); // Bloque s칩lido
        g.lineStyle(2, 0xffffff, 1); g.strokeRect(0, 0, 32, 32); // Borde blanco
        g.generateTexture('groundTex', 32, 32);

        // --- AQU칈 EST츼 LA MAGIA DE LA SKIN ---
        // 1. Leemos el color guardado en el men칰 (o usamos Cyan por defecto)
        let savedColor = localStorage.getItem('skinColor') || '0x00ffff';
        // 2. Convertimos el texto a n칰mero hexadecimal real
        let playerColor = parseInt(savedColor, 16);

        // Personaje (Usando el color elegido)
        g.clear(); g.fillStyle(playerColor, 1); g.fillRect(0, 0, 30, 45);
        g.generateTexture('dudeTex', 30, 45);
        // -------------------------------------

        // Fantasma (C칤rculo Blanco)
        g.clear(); g.fillStyle(0xffffff, 0.9); g.fillCircle(15, 15, 15);
        g.generateTexture('ghostTex', 30, 30);

        // Roca (Gris)
        g.clear(); g.fillStyle(0x888888, 1); g.fillCircle(8, 8, 8);
        g.generateTexture('rockTex', 16, 16);

        // Pincho (Tri치ngulo Rojo)
        g.clear(); g.fillStyle(0xff0000, 1);
        g.beginPath(); g.moveTo(0, 32); g.lineTo(16, 0); g.lineTo(32, 32); g.closePath(); g.fillPath();
        g.generateTexture('spikeTex', 32, 32);

        // Llave (Dorada)
        g.clear(); g.fillStyle(0xffd700, 1); g.fillCircle(10, 10, 10);
        g.generateTexture('keyTex', 20, 20);

        // ---------------------------------------------------------
        // 2. CONFIGURACI칍N DEL MUNDO
        // ---------------------------------------------------------
        // El juego ocurre solo en la parte de arriba (0 a 500px). 
        // Los 칰ltimos 100px (500 a 600) son para botones.
        this.physics.world.setBounds(0, 0, 2400, 500); 
        
        // Fondo infinito
        this.add.tileSprite(0, 0, 2400, 600, 'skyTex').setOrigin(0, 0).setScrollFactor(0.5).setScale(4);

        // ---------------------------------------------------------
        // 3. NIVEL 1 (DISE칌O)
        // ---------------------------------------------------------
        platforms = this.physics.add.staticGroup();
        spikes = this.physics.add.staticGroup();

        // -- SUELO BASE --
        // Lo ponemos en Y=484 para que el personaje camine justo encima de la barra negra de botones (Y=500)
        createPlatform(1000, 484, 80); 

        // -- OBST츼CULOS Y PLATAFORMAS --
        // Salto inicial
        createPlatform(400, 350, 6);
        
        // Trampa simple
        createPlatform(700, 250, 4);
        spikes.create(700, 218, 'spikeTex'); // Pincho sorpresa arriba

        // Zona de combate
        createPlatform(1100, 350, 5);
        
        // Puente peligroso (pinchos abajo)
        createPlatform(1500, 300, 4);
        spikes.create(1500, 452, 'spikeTex'); // Si te caes aqu칤, mueres

        // Meta (muy lejos)
        createPlatform(2200, 200, 8);

        // -- OBJETOS --
        // Llave (Escondida en una plataforma alta)
        keyItem = this.physics.add.sprite(1100, 300, 'keyTex');
        keyItem.setBounce(0.5); // Rebota un poco

        // Puerta (Rect치ngulo amarillo al final)
        door = this.add.rectangle(2200, 150, 40, 60, 0x555555); // Gris cerrada
        this.physics.add.existing(door, true);

        // ---------------------------------------------------------
        // 4. JUGADOR
        // ---------------------------------------------------------
        player = this.physics.add.sprite(100, 300, 'dudeTex');
        player.setBounce(0.1);
        player.setCollideWorldBounds(true); // No se sale del mundo (2400px)

        // ---------------------------------------------------------
        // 5. ENEMIGOS (Fantasmas)
        // ---------------------------------------------------------
        ghosts = this.physics.add.group();
        rocks = this.physics.add.group({ defaultKey: 'rockTex', maxSize: 20 });

        spawnGhost(600, 250);
        spawnGhost(1200, 150);
        spawnGhost(1800, 250);

        // ---------------------------------------------------------
        // 6. COLISIONES
        // ---------------------------------------------------------
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(keyItem, platforms);
        this.physics.add.collider(ghosts, platforms);
        this.physics.add.collider(rocks, platforms, (r) => r.destroy()); // Roca choca pared

        // Interacciones
        this.physics.add.overlap(player, spikes, takeDamage, null, this);
        this.physics.add.overlap(player, ghosts, takeDamage, null, this);
        this.physics.add.overlap(rocks, ghosts, killGhost, null, this);
        this.physics.add.overlap(player, keyItem, collectKey, null, this);
        this.physics.add.overlap(player, door, enterDoor, null, this);

        // ---------------------------------------------------------
        // 7. C츼MARA
        // ---------------------------------------------------------
        this.cameras.main.setBounds(0, 0, 2400, 600);
        this.cameras.main.startFollow(player, true, 0.08, 0.08);

        // ---------------------------------------------------------
        // 8. CONTROLES (PC y M칩vil)
        // ---------------------------------------------------------
        cursors = this.input.keyboard.createCursorKeys();
        keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);

        // Interfaz T치ctil (La barra negra abajo)
        createInterface(this);
    }

    // --- FUNCIONES AUXILIARES ---
    function createPlatform(x, y, widthScale) {
        platforms.create(x, y, 'groundTex').setScale(widthScale, 1).refreshBody();
    }

    function spawnGhost(x, y) {
        let g = ghosts.create(x, y, 'ghostTex');
        g.setBounce(1);
        g.setCollideWorldBounds(true);
        g.setVelocityX(-120); // Se mueve a la izquierda
        g.body.allowGravity = false; // Vuela
    }

    function update(time, delta) {
        if (isGameOver) return;

        player.setVelocityX(0);

        // Inputs combinados (Teclado || T치ctil)
        const isLeft = moveLeft || cursors.left.isDown;
        const isRight = moveRight || cursors.right.isDown;
        const isJump = jump || cursors.up.isDown || cursors.space.isDown;
        const isShoot = shoot || keyZ.isDown;

        if (isLeft) {
            player.setVelocityX(-300);
            facingRight = false;
        } else if (isRight) {
            player.setVelocityX(300);
            facingRight = true;
        }

        if (isJump && (player.body.touching.down || player.body.blocked.down)) {
            player.setVelocityY(-650);
            jump = false; 
        }

        if (isShoot && time > lastFired) {
            fireRock(time);
        }

        // UI Updates
        txtLives.setText('VIDAS: ' + lives);
        txtAmmo.setText('ROCAS: ' + ammo);
    }

    function fireRock(time) {
        if (ammo <= 0) return;
        let r = rocks.get(player.x, player.y);
        if (r) {
            r.setActive(true).setVisible(true);
            r.body.allowGravity = true;
            r.setVelocity(facingRight ? 500 : -500, -200);
            ammo--;
            lastFired = time + 400; 
        }
    }

    function takeDamage() {
        lives--;
        player.setTint(0xff0000); // Rojo de dolor
        player.setVelocityY(-400);
        player.x -= 50; // Retroceso
        
        this.time.delayedCall(500, () => player.clearTint());

        if (lives <= 0) {
            gameOver("游 GAME OVER");
        }
    }

    function killGhost(rock, ghost) {
        rock.destroy();
        ghost.destroy();
    }

    function collectKey(player, key) {
        key.disableBody(true, true); // Desaparece
        hasKey = true;
        door.fillColor = 0xffd700; // La puerta se pone dorada (abierta)
        txtInfo.setText("춰TIENES LA LLAVE! VE A LA PUERTA");
    }

    function enterDoor(player, door) {
        if (hasKey) {
            gameOver("游끥 춰NIVEL COMPLETADO!");
            // Aqu칤 ir칤a: window.location.href = "nivel2.html";
        } else {
            txtInfo.setText("游 NECESITAS LA LLAVE");
        }
    }

    function gameOver(msg) {
        isGameOver = true;
        this.physics.pause();
        alert(msg);
        location.reload(); // Reiniciar nivel
    }

    // --- INTERFAZ T츼CTIL (GAMEBOY STYLE) ---
    function createInterface(scene) {
        // Container FIJO (ignora la c치mara)
        uiContainer = scene.add.container(0, 0).setScrollFactor(0).setDepth(9999);

        // 1. BARRA SUPERIOR (Info)
        let topBar = scene.add.graphics();
        topBar.fillStyle(0x000000, 0.7);
        topBar.fillRect(0, 0, 800, 40);
        uiContainer.add(topBar);

        txtLives = scene.add.text(20, 10, 'VIDAS: 3', { fontSize: '20px', color: '#ff4444', fontStyle: 'bold' });
        txtAmmo = scene.add.text(650, 10, 'ROCAS: 10', { fontSize: '20px', color: '#ffffff', fontStyle: 'bold' });
        txtInfo = scene.add.text(200, 10, 'ENCUENTRA LA LLAVE', { fontSize: '16px', color: '#ffff00' });
        uiContainer.add([txtLives, txtAmmo, txtInfo]);

        // 2. BARRA INFERIOR (Controles) - ZONA SEGURA NEGRA
        let bottomBar = scene.add.graphics();
        bottomBar.fillStyle(0x111111, 1); // Negro s칩lido
        bottomBar.fillRect(0, 500, 800, 100); // Ocupa los 칰ltimos 100px
        bottomBar.lineStyle(4, 0x00ff00); // L칤nea ne칩n separadora
        bottomBar.lineBetween(0, 500, 800, 500);
        uiContainer.add(bottomBar);

        const btnY = 550; // Centrados en la barra negra

        // Botones Izquierda/Derecha
        let btnL = createBtn(scene, 100, btnY, '<', 0x333333, () => moveLeft=true, () => moveLeft=false);
        let btnR = createBtn(scene, 220, btnY, '>', 0x333333, () => moveRight=true, () => moveRight=false);
        
        // Botones Acci칩n
        let btnF = createBtn(scene, 580, btnY, 'FIRE', 0x555555, () => shoot=true, () => shoot=false);
        let btnJ = createBtn(scene, 700, btnY, 'JUMP', 0xaa0000, () => jump=true, () => jump=false);

        uiContainer.add([btnL, btnR, btnF, btnJ]);
    }

    function createBtn(scene, x, y, text, color, downFn, upFn) {
        let btn = scene.add.container(x, y);
        let circle = scene.add.circle(0, 0, 40, color).setStrokeStyle(2, 0xffffff);
        let label = scene.add.text(-15, -15, text, { fontSize: '20px', fontStyle: 'bold' });
        if(text.length > 2) label.x = -25; // Ajuste para palabras largas
        
        let hit = scene.add.circle(0, 0, 55, 0x000000, 0).setInteractive();
        hit.on('pointerdown', () => { downFn(); btn.y += 4; });
        hit.on('pointerup', () => { upFn(); btn.y -= 4; });
        hit.on('pointerout', () => { upFn(); btn.y -= 4; });

        btn.add([circle, label, hit]);
        return btn;
    }
</script>

</body>
</html>
